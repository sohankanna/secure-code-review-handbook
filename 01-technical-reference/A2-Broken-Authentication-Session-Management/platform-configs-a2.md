# Platform Configurations (A2): Hardening `web.config`, `web.xml`, & `php.ini`

## 1. Executive Summary
Security is not just code; it is also configuration. Modern frameworks manage sessions and authentication via configuration files. A Secure Code Reviewer must inspect these files just as rigorously as the source code.

**The Goal:** Ensure the platform handles Session IDs securely (Cookies vs. URLs), enforces encryption (SSL/TLS), and times out idle sessions automatically.

---

## 2. ASP.NET Configuration (`web.config`)
In the .NET ecosystem, the `web.config` file controls the behavior of the IIS server and the ASP.NET framework.

### A. Authentication Mode & Cookie Protection
**Reference:** Sample 8.2 (PDF p. 66) & Sample 11.32 (PDF p. 113)

The `<authentication>` and `<forms>` tags are critical. Reviewers must ensure the cookie is not sent over clear text and that URL rewriting is disabled.

#### ðŸš© Vulnerable Configuration
```xml
<authentication mode="Forms">
   <!-- VULNERABLE: SSL not required, URL rewriting allowed, weak protection -->
   <forms loginUrl="login.aspx" 
          requireSSL="false" 
          cookieless="UseUri" 
          protection="None" />
</authentication>
```

#### âœ… Secure Configuration (Hardened)
```xml
<authentication mode="Forms">
  <forms loginUrl="Restricted\login.aspx"
         name="SecureAuthCookie"
         path="/"
         requireSSL="true"           <!-- 1. Forces HTTPS for the cookie -->
         cookieless="UseCookies"     <!-- 2. Disables URL rewriting (Session Fixation protection) -->
         protection="All"            <!-- 3. Encrypts AND Validates the cookie data -->
         timeout="15"                <!-- 4. Short session timeout (minutes) -->
         slidingExpiration="true"    <!-- 5. Refreshes timeout on activity -->
         />
</authentication>
```

**Reviewer Checklist for `<forms>`:**
*   **`requireSSL="true"`**: Mandatory. Prevents the "Secure" flag from being missing on the cookie.
*   **`cookieless="UseCookies"`**: Mandatory. If set to `AutoDetect` or `UseUri`, the framework might put the Session ID in the URL (e.g., `http://site/(SessionID)/home`), which leads to Session Hijacking via referrer headers.
*   **`protection="All"`**: Ensures the cookie is both encrypted (confidentiality) and validated (integrity).

### B. Session State & Timeouts
**Reference:** Sample 8.5 (PDF p. 67)

The `<sessionState>` tag controls the "server-side" memory of the session.

```xml
<system.web>
  <!-- Timeout is in MINUTES -->
  <sessionState mode="InProc"
                cookieless="false" 
                timeout="15" 
                cookieName="id" /> <!-- Rename default ASP.NET_SessionId -->
</system.web>
```

**Reviewer Insight:** 
*   **Timeout:** The default is often 20 minutes. For high-security apps (banking), this should be reduced (e.g., 5-10 minutes).
*   **Cookie Name:** Renaming the cookie (e.g., to `id`) obscures the underlying technology from attackers.

### C. The `httpCookies` Element
**Reference:** Table 17 (FxCop Flags, PDF p. 115)

This element applies settings to *all* cookies generated by the application.

```xml
<system.web>
    <!-- Enforces HttpOnly and Secure flags globally -->
    <httpCookies httpOnlyCookies="true" requireSSL="true" />
</system.web>
```
*   **`httpOnlyCookies="true"`**: Critical defense against XSS. It prevents client-side scripts (`document.cookie`) from accessing the session token.

---

## 3. Java EE Configuration (`web.xml`)
In Java web applications (J2EE/Jakarta EE), the `web.xml` deployment descriptor handles session security.

### A. Session Configuration (The "Cookie Config" Block)
**Reference:** Sample 8.3 (PDF p. 66)

This is the standard way to enforce flags on the `JSESSIONID` cookie.

```xml
<session-config>
    <!-- 1. Session Timeout (In MINUTES) -->
    <session-timeout>15</session-timeout>

    <!-- 2. Cookie Security Flags -->
    <cookie-config>
        <http-only>true</http-only> <!-- Prevents XSS access -->
        <secure>true</secure>       <!-- Prevents transmission over HTTP -->
        <name>SID</name>            <!-- Obscures "JSESSIONID" -->
    </cookie-config>
    
    <!-- 3. Tracking Mode -->
    <tracking-mode>COOKIE</tracking-mode> <!-- Disables URL Rewriting -->
</session-config>
```

**Reviewer Note:** If `<tracking-mode>URL</tracking-mode>` is present, mark it as a **High** severity finding. This enables URL rewriting, leading to session leaks.

### B. Declarative Security Constraints
**Reference:** Sample 11.2 (PDF p. 85)

Java allows you to define authentication rules in XML rather than code. This is often safer because it applies globally to URL patterns.

```xml
<security-constraint>
    <web-resource-collection>
        <web-resource-name>Protected Area</web-resource-name>
        <url-pattern>/admin/*</url-pattern> <!-- Applies to everything in /admin -->
        <http-method>GET</http-method>
        <http-method>POST</http-method>
    </web-resource-collection>

    <!-- Enforce Authorization (Role Check) -->
    <auth-constraint>
        <role-name>manager</role-name>
    </auth-constraint>

    <!-- Enforce SSL (Transport Guarantee) -->
    <user-data-constraint>
        <transport-guarantee>CONFIDENTIAL</transport-guarantee>
    </user-data-constraint>
</security-constraint>
```

**Reviewer Checklist:**
*   **`CONFIDENTIAL`**: This keyword forces the server to use SSL/TLS for these URLs. If it says `NONE`, data is sent in clear text.
*   **`http-method`**: Ensure risky methods (DELETE, PUT) are restricted or not listed (if default deny is not active).

---

## 4. PHP Configuration (`php.ini`)
**Reference:** Sample 8.9 (PDF p. 69)

PHP configuration is often global (`php.ini`), but can sometimes be overridden in `.htaccess` or code (`ini_set`). Ideally, review the global config.

### A. Preventing URL Rewriting
The most common PHP session vulnerability is **Trans SID** (Transparent Session ID), where PHP appends `?PHPSESSID=...` to every link if cookies are disabled.

**Secure Configuration:**
```ini
; Prevent the session ID from appearing in the URL
session.use_trans_sid = 0

; Force the use of cookies to store the Session ID
session.use_only_cookies = 1

; (Modern PHP) Prevent JavaScript access to the cookie
session.cookie_httponly = 1

; (Modern PHP) Force cookie over HTTPS only
session.cookie_secure = 1
```

### B. Session Entropy
Ensure the session ID generation is strong (using a secure hash algorithm like SHA-256 rather than MD5).

```ini
; 1 = MD5, 0 = SHA-1 (Older PHP)
; Check documentation for specific version, aim for SHA-256 support
session.hash_function = 1 

; Increase the bits per character for higher entropy
session.hash_bits_per_character = 5
```

---

## 5. Web Server Headers (IIS & Apache)
**Reference:** Table 11 (PDF p. 53)

While technically "A5: Security Misconfiguration," these headers are vital for protecting the **Authentication Session** from XSS and Clickjacking.

### Key Headers to Review (in `web.config` or `.htaccess`)

| Header | Value | Purpose |
| :--- | :--- | :--- |
| **Strict-Transport-Security** | `max-age=31536000; includeSubDomains` | **HSTS:** Tells the browser to *never* allow an HTTP connection, protecting the session cookie from being stripped. |
| **X-Frame-Options** | `DENY` or `SAMEORIGIN` | Prevents **Clickjacking**, where an attacker overlays a fake login button over your real site. |
| **X-Content-Type-Options** | `nosniff` | Prevents the browser from guessing content types (mitigates XSS). |

---

## 6. Secure Code Reviewerâ€™s Config Checklist

### ASP.NET
- [ ] Is `<authentication mode="Forms">` used with `requireSSL="true"`?
- [ ] Is `cookieless="UseCookies"` set? (Disabling URL/Uri modes).
- [ ] Is `<httpCookies httpOnlyCookies="true">` present?
- [ ] Is `<customErrors mode="On">` set to prevent leaking stack traces during auth failures?

### Java
- [ ] Does `web.xml` contain `<cookie-config><http-only>true</http-only>`?
- [ ] Is `<transport-guarantee>CONFIDENTIAL</transport-guarantee>` applied to sensitive paths?
- [ ] Is `<tracking-mode>COOKIE</tracking-mode>` set?

### PHP
- [ ] Is `session.use_only_cookies` set to `1`?
- [ ] Is `session.use_trans_sid` set to `0`?
- [ ] Is `session.cookie_httponly` set to `1`?

---

*Reference: OWASP Code Review Guide 2.0 (Pages 66-69, 85, 113)*
